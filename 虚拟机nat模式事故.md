# 虚拟机nat模式事故
## 事故环境
事故环境描述:
- 主机(192.172.1.186)，虚拟机(192.168.137.128)，通过上述方式配置主机和虚拟机使用nat模式通信（因为公司wlan限制了mac地址上网）
- 虚拟机和主机之间是能互相ping通的，且虚拟机访问外网是正常的
  事故过程:
- 发现每过一段时间无法新建ssh连接，但是旧的ssh连接依然可以使用，此时主机无法ping通虚拟机（难道是nat模式的网络不稳定）
- 重启虚拟机，发现没有用，主机仍然ping不通虚拟机，虚拟机是正常的
- 重启主机，发现主机又可以ping通虚拟机了，一切又正常了。但是过一段时间故障又出现了
  疑问：
- 应该是nat模式出问题了，但是为什么虚拟机访问主机又是正常的呢，windows上有什么软件或者命令可以查看nat情况呢（当时没找到，真需要好好补补网络知识）

在这种情况下纠结了好几天，适用了其他虚拟机网络模式也是类似问题，什么鬼。

## 问题定位
终于下定大决心定位解决这个问题，过程如下：
- 按正常操作流程，开机，开启虚拟机，测试网络正常
- 打开主机命令行 `ping 192.168.137.128 -t`，不停ping虚拟机，此时是正常的（监控什么时候异常出现）
- 准备开始搬砖，打开vpn，连接搬砖用的网络。什么鬼，怎么命令行ping超时了，再次关闭vpn，又正常了

## 最终解决方案
经过多番网络知识学习后解决方案如下:
- 打开一个主机命令行窗口 `ping 192.168.137.128 -t`，不停ping虚拟机在主机命令行
- 连vpn前，打开一个主机命令行窗口 `route print`，查看主机和虚拟机nat路由表信息，大致如下
  ```
  IPv4 路由表
  ===========================================================================
  活动路由:
  网络目标        网络掩码          网关       接口   跃点数
  ...
  192.168.137.0    255.255.255.0            在链路上     192.168.137.1    291
  192.168.137.1  255.255.255.255            在链路上     192.168.137.1    291
  ...
  ```
- 连vpn后，打开一个主机命令行窗口 `route print`，查看主机和虚拟机nat路由表信息，大致如下
  ```
  IPv4 路由表
  ===========================================================================
  活动路由:
  网络目标        网络掩码          网关       接口   跃点数
  ...
  192.168.137.0    255.255.255.0            在链路上     192.168.137.1    291
  192.168.137.0    255.255.255.0       10.0.232.1     10.0.233.178     10
  192.168.137.1  255.255.255.255            在链路上     192.168.137.1    291
  ...
  ```
- 发现原来连vpn后，主机和nat模式的虚拟机之间多了一条路由表信息，指需要删除这条多余的路由表信息即可。操作步骤如下:
  ```shell
  # 删除192.168.137.0的路由表
  route delete 192.168.137.0
  # 添加192.168.137.0路由表指向NAT网关（NAT网卡IP）
  route add -p 192.168.137.0 mask 255.255.255.0 192.168.137.1
  #此时192.168.137.0段的虚拟机可以被正常访问，route print 命令显示的路由信息也正常了
  ```
